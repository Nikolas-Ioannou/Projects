# HOMEWORK 2

# Πώς τρέχουμε το πρόγραμμα
Αρχικά εκτελούμε την εντολή:
 - make
και παράγονται τα αρχεία:
 - nfs_client
 - nfs_console
 - nfs_manager
Στη συνέχεια, κάνουμε split το terminal και εκτελούμε σε σειρά τις εντολές:
- ./nfs_manager -l <manager_logfile> -c <config_file> -n <worker_limit> -p <port_number> -b <bufferSize>
- ./nfs_console -l <console-logfile> -h <host_IP> -p <host_port>

# nfs_console
Στο nfs_console δίνονται οι εντολές που θέλει να εκτελέσει ο χρήστης. Πιο συγκεκριμένα, οι διαθέσιμες εντολές είναι οι εξής:
    - **add <source> <target>**: Προσθέτει ένα νέο ζεύγος καταλόγων για συγχρονισμό.
    - **cancel <source>**: Ακυρώνει τον συγχρονισμό του καταλόγου <source>.
    - **shutdown**: Σταματά τη λειτουργία του διαχειριστή και των εργαζομένων.
Η επικοινωνία μεταξύ του nfs_console και του nfs_manager γίνεται με τη χρήση ενός socket. Πιο συγκεκριμένα, ο nfs_console στέλνει τις εντολές στον nfs_manager μέσω του socket. Στη συνέχεια, ο nfs_manager τις λαμβάνει, τις εκτελεί και στέλνει πίσω στον nfs_console τα κατάλληλα μηνύματα.
Ο nfs_console, όταν λάβει τα μηνύματα, τα εμφανίζει στην οθόνη και καταγράφει τη λειτουργία που έγινε στο αρχείο καταγραφής (logfile). Όταν δοθεί η εντολή shutdown, τότε ο nfs_console τερματίζει τη λειτουργία του, όπως και ο nfs_manager.

# nfs_client
Στο nfs_client δίνονται εντολές που θέλει να εκτελέσει ο nfs_manager. Πιο συγκεκριμένα, οι εντολές που λαμβάνει είναι οι εξής:
    - **LIST source_dir**: Στέλνει πίσω μία λίστα με τα αρχεία που υπάρχουν στο συγκεκριμένο directory. Η συνάρτηση που υλοποιεί αυτή τη λειτουργία είναι η list_files.
    - **PULL /source_dir/file.txt**: Στέλνει πίσω στο host το συγκεκριμένο αρχείο, εφόσον υπάρχει, με το format <filesize> <space> <data…>. Αυτή την εντολή την εφαρμόζει η συνάρτηση pull_file.
    - **PUSH /target_dir/file.txt chunk_size data**:Σε αυτή την εντολή, αν το chunk_size είναι -1, τότε το αρχείο θα πρέπει να γραφτεί από την αρχή και γράφει τα data στο αρχείο. Αν το chunk_size είναι 0, αυτό σημαίνει πως έχει γραφτεί όλο το αρχείο και επομένως μπορεί να το κλείσει. Η συνάρτηση που κάνει αυτή την λειτουργία είναι η push_file. Πιο συγκεκριμένα, παίρνει την εντολή και βλέπει το chunk_size αν είναι -1 ή 0. Αν είναι -1, τότε κάνει truncate στο αρχείο και μετά περιμένει την επόμενη εντολή που θα είναι του ίδιου τύπου. Δηλαδή, αν το chunk_size είναι -1, θα γίνει η ίδια διαδικασία, αλλιώς θα γίνει κλείσιμο του αρχείου. Αν από την αρχή δοθεί chunk_size 0, τότε απλώς ανοίγει το αρχείο και το κλείνει.
Παραδοχή: O κάθε nfs_client είναι μοναδικός και δημιουργείται απο τον nfs_manager.
# nfs_manager

Ο nfs_manager βοηθηάει στην την επικοινωνία μεταξύ source και target clients,ώστε να γίνει ο συγχρονισμός 2 καταλόγων.Επίσης,δέχεται απο τον nfs_console τις εντολές:
    - **add <source> <target>**: Όπου γίνεται συχρονισμός 2 καταλόγων με βάση τους host και ports που έχουν δοθεί.
    - **cancel <source>**: Όπου γίνεται ο τερματισμός ενός συγχρονισμού με βάση το source που έχει δοθεί.Πιο συγκεκριμένα, αν υπάρχει στην queue ως source αυτό που δόθηκε δεν εκτελείται.
    - **shutdown**: Γίνεται τερματισμός των προγραμμάτων nfs_manager και nfs_console.

## Δομή nfs_manager

Αρχικά, ο nfs_manager διαβάζει τα ορίσματα τα οποία του δίνονται από τη γραμμή εντολών (command line), τα αποθηκεύει στις κατάλληλες δομές δεδομένων,δημιουργεί την επικοινωνία μεταξύ nfs_console και nfs_manager,δημιουργεί τους nfs_clients και διαβάζει και εκτελεί τον συχρονισμό καταλόγων με βάση το config_file.
Παραδοχή: Πρέπει όλα τα ports να είναι διαφορετικά. 
### Σημαντικά αντικείμενα:

- **headnode**:  
  Περιέχει όλα τα ζεύγη source και target clients, την επικοινωνία μεταξύ τους, πόσα αρχεία έχουν συγχρονιστεί έως τώρα, πόσα πρέπει να συγχρονιστούν συνολικά, και άλλα σχετικά δεδομένα.

- **headqueue**:  
  Μια ουρά όπου αποθηκεύονται τα ζεύγη source και target clients με το όνομα του αρχείου που πρόκειται να συγχρονιστεί.Χρησιμοποιείται όταν δεν υπάρχουν διαθέσιμα worker threads. Δεν έχει μέγιστο μέγεθος καθώς υλοποιείται ως λίστα.

- **pool**:  
  Περιέχει δεδομένα για τα worker threads. Συγκεκριμένα, βοηθά στη δημιουργία worker threads, στην παρακολούθηση τους,για το πότε ένα thread ολοκληρώνεται, καθώς και στη διαδικασία συγχρονισμού δεδομένων.

- **client_socket**:  
  Χρησιμοποιείται για την επικοινωνία μεταξύ nfs_manager και nfs_console.

### Βασικός βρόχος λειτουργίας

Ο nfs_manager εκτελεί έναν συνεχόμενο βρόχο στον οποίο πραγματοποιείται ο συγχρονισμός με βάση το config_file και η λήψη/εκτέλεση εντολών από το nfs_console.

Αναλυτικά η διαδικασία:

1. **Έλεγχος ολοκλήρωσης worker threads**:  
   Αν ένας worker έχει ολοκληρώσει,έχουμε freethread[i] == -2,όπου i ο worker που τερματίστηκε ,τότε το thread θεωρείται ελεύθερο κα βάζουμαι την τιμή freethread[i] = -1.Μετά, γίνεται έλεγχος αν ο συγχρονισμός για το συγκεκριμένο ζεύγος source-target ολοκληρώθηκε και εμφανίζονται/καταγράφονται τα κατάλληλα μηνύματα.

2. **Εκτέλεση ουράς εργασιών**:  
   Ελέγχει αν υπάρχουν λειτουργίες στην ουρά headqueue και τις εκτελεί μέχρι να μην υπάρχουν διαθέσιμα worker threads.

3. **Διάβασμα config_file**:  
   Παίρνει ένα ζεύγος από το config_file και:
   - Ελέγχει το source δεν έχει client.Αν δεν έχει τότε δημιουργεί την κατάλληλη επικοινωνία μαζί του και κάνει spawn τον client.Το ίδιο γίνεται και στο target.
   - Στέλνει την εντολή List στον source client για να λάβει όλα τα αρχεία του καταλόγου του.
   - Προσπαθεί να δημιουργήσει worker threads (αν υπάρχουν διαθέσιμα). Αν όχι, προσθέτει την εργασία στην ουρά.

4. **Λειτουργία worker_function**:  
    O κάθε worker λαμβάνει τα δεδομένα του αρχείου από τον source client μέσω της εντολής PULL και τα στέλνει στον target client εκεί μέσω της εντολής PUSH.

5. **Αναμονή εντολών από nfs_console**:  
   Στο τέλος κάθε επανάληψης του βρόχου, περιμένει για 5 δευτερόλεπτα μήπως λάβει εντολή από τον nfs_console. Αν δεν λάβει, συνεχίζει τον βρόχο και θα το διαβάσει αργότερα. Αν λάβει κάποιο δεδομένο μπορεί να ετκελέσει τις παρακάτω εντολές:
   - **shutdown**: Εκτελεί όλα τα στοιχεία που υπάρχουν στην ουρά, πραγματοποιεί τον υπόλοιπο συγχρονισμό απο το config_file και τερματίζει το πρόγραμμα.
   - **add**: Εκτελεί έναν συγχρονισμό με βάση τα νέα δεδομένα.
   - **cancel**: Διακόπτει τον συγχρονισμό μεταξύ ενός source και target με διαγραφή των σχετικών στοιχείων από την ουρά.



